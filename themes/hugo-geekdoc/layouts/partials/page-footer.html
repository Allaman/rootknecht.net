{{ $current := . }}
{{ $site := .Site }}
{{ $current.Scratch.Set "prev" false }}
{{ $current.Scratch.Set "getNext" false }}

{{ $current.Scratch.Set "nextPage" false }}
{{ $current.Scratch.Set "prevPage" false }}

{{ template "menu_nextprev" dict "sect" $.Site.Data.menu.main.main "current" $current "site" $site }}

{{ define "menu_nextprev" }}
    {{ $current := .current }}
    {{ $site := .site }}

    {{ range sort (default (seq 0) .sect) "weight" }}
        {{ $current.Scratch.Set "current" $current }}
        {{ $current.Scratch.Set "site" $site }}

        {{ $ref := default false .ref }}
        {{ if $ref}}
            {{ $site := $current.Scratch.Get "site" }}
            {{ $this := $site.GetPage .ref }}
            {{ $current := $current.Scratch.Get "current" }}

            {{ if $current.Scratch.Get "getNext" }}
                {{ $current.Scratch.Set "nextPage" (dict "name" .name "this" $this) }}
                {{ $current.Scratch.Set "getNext" false }}
            {{ end }}

            {{ if eq $current $this }}
                {{ $current.Scratch.Set "prevPage" ($current.Scratch.Get "prev") }}
                {{ $current.Scratch.Set "getNext" true }}
            {{ end }}

            {{ $current.Scratch.Set "prev" (dict "name" .name "this" $this) }}
        {{ end }}

        {{ $sub := default false .sub }}
        {{ if $sub }}
            {{ template "menu_nextprev" dict "sect" $sub "current" ($current.Scratch.Get "current") "site" ($current.Scratch.Get "site") }}
        {{ end }}
    {{ end }}
{{ end }}


{{ $geekdocRepo := default (default false .Site.Params.GeekdocRepo) .Page.Params.GeekdocRepo }}
{{ $geekdocEditPath := default (default false .Site.Params.GeekdocEditPath) .Page.Params.GeekdocEditPath }}
{{ if .File }}
    {{ $.Scratch.Set "geekdocFilePath" (default .File.Path .Page.Params.GeekdocFilePath) }}
{{ else }}
    {{ $.Scratch.Set "geekdocFilePath" false }}
{{ end }}

{{ define "breadcrumb" }}
    {{ $parent := .page.Parent }}
    {{ if $parent }}
        {{ $name := (partial "title" $parent) }}
        {{ $position := (sub .position 1) }}
        {{ $value := (printf "<li itemprop='itemListElement' itemscope itemtype='https://schema.org/ListItem'><a itemscope itemtype='https://schema.org/WebPage' itemprop='item' itemid='%s' href='%s'><span itemprop='name'>%s</span></a><meta itemprop='position' content='%d' /></li><li> / </li>%s" $parent.RelPermalink $parent.RelPermalink $name $position .value) }}
        {{ template "breadcrumb" dict "page" $parent "value" $value "position" $position }}
    {{ else }}
        {{ .value | safeHTML }}
    {{ end }}
{{ end }}
{{ $showBreadcrumb := (and (default true .Page.Params.GeekdocBreadcrumb) (default true .Site.Params.GeekdocBreadcrumb)) }}
{{ $showEdit := (and ($.Scratch.Get "geekdocFilePath") $geekdocRepo $geekdocEditPath) }}
<div class="gdoc-page__header flex flex-wrap
    {{ if $showBreadcrumb }} justify-between {{ else }} justify-end {{ end }}
    {{ if not $showEdit }} hidden-mobile {{ end }}
    {{ if (and (not $showBreadcrumb) (not $showEdit)) }} hidden {{ end }}" itemprop="breadcrumb">
    {{if $showBreadcrumb }}
    <div>
        <svg class="icon gdoc_path hidden-mobile"><use xlink:href="#gdoc_path"></use></svg>
        <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
            {{ $position := sub (len (split .RelPermalink "/")) 1 }}
            {{ $name := (partial "title" .) }}
            {{ $value := (printf "<li itemprop='itemListElement' itemscope itemtype='https://schema.org/ListItem'><span itemprop='name'>%s</span><meta itemprop='position' content='%d' /></li>" $name $position ) }}
            {{ template "breadcrumb" dict "page" . "value" $value "position" $position }}
        </ol>
    </div>
    {{ end }}
    {{ if $showEdit }}
    <div>
        <span class="editpage">
            <svg class="icon gdoc_code"><use xlink:href="#gdoc_code"></use></svg>
            <a href="{{ $geekdocRepo }}/{{ path.Join $geekdocEditPath ($.Scratch.Get "geekdocFilePath") }}">
                Edit this page
            </a>
        </span>
    </div>
    {{ end }}
</div>


<div class="gdoc-page__footer flex flex-wrap justify-between">
    {{ $showPrevNext := (and (default true .Site.Params.GeekdocNextPrev) .Site.Params.GeekdocMenuBundle) }}
    {{ if $showPrevNext }}
        <span class="gdoc-page__nav">
            {{ with ($current.Scratch.Get "prevPage") }}
                <a class="gdoc-page__nav--prev flex align-center" href="{{.this.RelPermalink}}" title="{{ .name }}"> {{ .name }}</a>
            {{ end }}
        </span>
        <span class="gdoc-page__nav">
            {{ with ($current.Scratch.Get "nextPage") }}
                <a class="gdoc-page__nav--next flex align-center" href="{{.this.RelPermalink}}" title="{{ .name }}">{{ .name }} </a>
            {{ end }}
        </span>
    {{ end }}
</div>
